<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>éŸ³å£°ã‚¿ã‚¹ã‚¯ç™»éŒ²</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  button { margin: 5px; padding: 10px 20px; }
  #status { margin-top: 10px; }
</style>
</head>
<body>
<h1>ã‚¹ãƒãƒ›ã§éŒ²éŸ³ â†’ Notion ã‚¿ã‚¹ã‚¯ç™»éŒ²</h1>

<button id="startBtn">éŒ²éŸ³é–‹å§‹</button>
<button id="stopBtn" disabled>éŒ²éŸ³åœæ­¢</button>

<p id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¾…æ©Ÿä¸­</p>

<script>
let mediaRecorder;
let audioChunks = [];

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const statusEl = document.getElementById('status');

startBtn.addEventListener('click', async () => {
  statusEl.textContent = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: éŒ²éŸ³ä¸­...";
  audioChunks = [];
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.start();
  startBtn.disabled = true;
  stopBtn.disabled = false;
});

stopBtn.addEventListener('click', () => {
  mediaRecorder.stop();
  
  // ğŸ”½ ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢ï¼ˆãƒã‚¤ã‚¯è§£æ”¾ï¼‰
  mediaRecorder.stream.getTracks().forEach(track => track.stop());

  mediaRecorder.onstop = async () => {
    statusEl.textContent = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒ‡ãƒ¼ã‚¿å¤‰æ›ä¸­...";
    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
    
    // Base64 ã«å¤‰æ›
    const reader = new FileReader();
    reader.onloadend = async () => {
    const base64data = reader.result.split(',')[1]; // æ­£ã—ãæŠ½å‡º

    statusEl.textContent = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ã‚µãƒ¼ãƒé€ä¿¡ä¸­...";
    try {
      const res = await fetch('/api/upload', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ audioBase64: base64data }) // â† ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼
      });
      const data = await res.json();
      statusEl.textContent = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å®Œäº† â†’ " + JSON.stringify(data);
    } catch (err) {
      statusEl.textContent = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ã‚¨ãƒ©ãƒ¼ â†’ " + err.message;
    }
    };

    reader.readAsDataURL(audioBlob);
  };
  startBtn.disabled = false;
  stopBtn.disabled = true;
});
</script>
</body>
</html>
